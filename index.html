
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pi Memory Game (Web)</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<link rel="icon" href='data:image/svg+xml;utf8,<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="white"/><text x="50%" y="54%" text-anchor="middle" font-size="44" font-family="Segoe UI, Arial, sans-serif">π</text></svg>' />
<style>
  :root { --gap10: 0.5ch; --ok: #1a8917; --bad: #cc0000; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
  h1 { margin: 0 0 8px; font-size: 20px; }
  .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .stats { display:flex; gap:12px; flex-wrap:wrap; font-size:14px; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; margin:10px 0; align-items:center; }
  button, input, select, label { font-size:14px; }
  #displayWrap { border:1px solid #ddd; border-radius:8px; padding:12px; height:360px; overflow:auto; background:#fff; }
  #digits { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; white-space: pre-wrap; line-height:1.4; }
  .d { display:inline; }
  .ok { color: var(--ok); }
  .bad { color: var(--bad); text-decoration: none; }
  .sp { display:inline-block; width: var(--gap10); }
  .nl { display:block; height:0; }
  #entryRow { display:flex; justify-content:center; margin-top:12px; }
  #entry { font-family: inherit; font-size: 18px; width: 240px; text-align:center; padding:6px 10px; }
  #footer { font-size:12px; color:#666; margin-top:10px; }
  #leaderboardList { margin: 6px 0 0; padding-left: 16px; }
  .muted { color:#888; }
  .hidden { display:none; }
  .fileTip { font-size:12px; color:#555; }
  .group { display:flex; gap:8px; align-items:center; }
  .sep { color:#aaa; }
  input[type="number"] { width:90px; }
  #ghUrl { width: 320px; }
</style>
</head>
<body>
  <h1>Pi Memory Game (Web)</h1>

  <div class="row stats">
    <div><strong>Score:</strong> <span id="score">0</span></div>
    <div><strong>Time:</strong> <span id="time">0.0s</span></div>
    <div><strong>Seconds/Digit:</strong> <span id="spd">0.00</span></div>
    <div class="muted">Target: <span id="targetCount">0</span> digits</div>
  </div>

  <div class="controls">
    <button id="toggle">Hide Digits</button>
    <button id="save">Save Progress</button>
    <button id="load">Load Progress</button>
    <button id="reset">Reset</button>

    <span class="sep">|</span>

    <button id="submitScore">Submit to Leaderboard</button>
    <details id="lbDetails">
      <summary>Leaderboard (Top 10)</summary>
      <ol id="leaderboardList"></ol>
    </details>

    <span class="sep">|</span>

    <label class="group" title="0 means start from the first digit (the leading 3 if enabled).">
      Start at:
      <input type="number" id="startAt" min="0" max="15000" step="1" value="0" />
    </label>

    <label class="group" title="If on, you type the leading 3 as the very first digit.">
      <input type="checkbox" id="include3" checked />
      Include leading “3”
    </label>

    <span class="sep">|</span>

    <div class="group">
      <label>Load π file:</label>
      <input type="file" id="fileInput" accept=".txt" />
      <button id="useDemo">Use demo 1000 digits</button>
    </div>

    <div class="group">
      <button id="loadFromRepo" title="Fetch pi_15000.txt relative to this page (e.g., on GitHub Pages).">Load pi_15000.txt from repo</button>
      <input id="ghUrl" type="url" placeholder="Or paste raw URL to pi_15000.txt and press Enter" />
    </div>
  </div>

  <div id="displayWrap">
    <div id="digits" title="Click a digit to jump the cursor back there."></div>
  </div>

  <div id="entryRow">
    <input id="entry" autocomplete="off" inputmode="numeric" placeholder="Type digits here…" />
  </div>

  <div id="footer" class="muted">
    Tip: With “Include leading 3” ON, you start by typing <strong>3</strong>, then the digits after the decimal. Spaces appear every 10 digits, a new line every 100. Click any digit to jump back and re-enter from there.
  </div>

<script>
(() => {
  // --------- State ----------
  // Stored format: "3.14159..." (leading 3 + dot + decimals)
  let piFull = "3.";
  let includeLeading3 = true; // if true, position 1 == "3"
  let startAt = 0;            // 0-based index into ACTIVE_SEQ()
  let input = [];
  let showDigits = true;
  let startTime = null;
  let elapsed = 0;
  let timerHandle = null;

  const MAX_PER_LINE = 100;
  const SPACE_EVERY = 10;
  const MAX_LEAD = 10;

  const STORAGE_KEYS = {
    SAVE: "piweb_save_v2",
    LB:   "piweb_leaderboard_v1",
    PI:   "piweb_pi_digits_v1"
  };

  // --------- Elements ----------
  const elDigits  = document.getElementById('digits');
  const elScore   = document.getElementById('score');
  const elTime    = document.getElementById('time');
  const elSPD     = document.getElementById('spd');
  const elToggle  = document.getElementById('toggle');
  const elSave    = document.getElementById('save');
  const elLoad    = document.getElementById('load');
  const elReset   = document.getElementById('reset');
  const elSubmit  = document.getElementById('submitScore');
  const elEntry   = document.getElementById('entry');
  const elLBList  = document.getElementById('leaderboardList');
  const elStartAt = document.getElementById('startAt');
  const elTarget  = document.getElementById('targetCount');
  const elFile    = document.getElementById('fileInput');
  const elUseDemo = document.getElementById('useDemo');
  const elInc3    = document.getElementById('include3');
  const elLoadRepo= document.getElementById('loadFromRepo');
  const elGhUrl   = document.getElementById('ghUrl');

  // --------- Helpers ----------
  // Make positions 1-based for UI: pos 1 = index 0
  const seqLen = () => ACTIVE_SEQ().length;
  const posToIndex = (pos) => Math.max(0, Math.min((+pos || 1) - 1, Math.max(0, seqLen() - 1)));
  const indexToPos = (idx) => idx + 1;

  // Return "3" + decimals (no dot)
  const getDigitsOnly = () => piFull.replace(/\D/g, "");

  // Active sequence the player types:
  function ACTIVE_SEQ() {
    const d = getDigitsOnly(); // begins with "3"
    return includeLeading3 ? d : d.slice(1);
  }

  function updateTargetCount() {
    const L = seqLen();
    elTarget.textContent = L.toLocaleString();
    elStartAt.max = String(L);
    elStartAt.value = String(indexToPos(startAt));
  }

  function startTimerIfNeeded() {
    if (startTime === null) {
      startTime = performance.now() - (elapsed * 1000);
      tick();
    }
  }
  function tick() {
    if (startTime === null) return;
    elapsed = (performance.now() - startTime) / 1000;
    elTime.textContent = `${elapsed.toFixed(1)}s`;
    const score = computeScore();
    elSPD.textContent = score > 0 ? (elapsed / score).toFixed(2) : "0.00";
    timerHandle = requestAnimationFrame(tick);
  }

  function computeScore() {
    const tgt = ACTIVE_SEQ().slice(startAt);
    let ok = 0;
    for (let i = 0; i < input.length && i < tgt.length; i++) {
      if (input[i] === tgt[i]) ok++;
    }
    return ok;
  }

  function resetGame(keepPi=true) {
    input = [];
    startTime = null;
    elapsed = 0;
    elTime.textContent = "0.0s";
    elSPD.textContent = "0.00";
    if (!keepPi) { piFull = "3."; localStorage.setItem(STORAGE_KEYS.PI, piFull); }
    render();
    elEntry.value = "";
    elEntry.focus();
  }

  function flash(btn, text) {
    const orig = btn.textContent;
    btn.textContent = text;
    btn.disabled = true;
    setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 1500);
  }

  // ----- Robust parsing for any pi text -----
  function parsePiText(txt) {
    // remove all whitespace; find first "3." with following digits
    const s = txt.replace(/\s+/g, "");
    const m = s.match(/3\.\d{1,}/);
    if (!m) throw new Error("No '3.' followed by digits found.");
    const digitsOnly = m[0].replace(".", ""); // "3" + decimals
    // Cap at leading 3 + 15000 decimals
    const capped = digitsOnly.slice(0, 1 + 15000);
    // Reassemble stored format "3.xxxxx"
    return capped[0] + "." + capped.slice(1);
  }

  // Save/Load progress
  function saveProgress() {
    const payload = { piFull, startAt, input, elapsed, includeLeading3 };
    localStorage.setItem(STORAGE_KEYS.SAVE, JSON.stringify(payload));
    flash(elSave, "Saved!");
  }
  function loadProgress() {
    const raw = localStorage.getItem(STORAGE_KEYS.SAVE);
    if (!raw) return flash(elLoad, "No save");
    try {
      const d = JSON.parse(raw);
      if (d.piFull && /^3\./.test(d.piFull)) piFull = d.piFull;
      includeLeading3 = !!d.includeLeading3;
      startAt = Number.isFinite(+d.startAt) ? +d.startAt : 0;
      input   = Array.isArray(d.input) ? d.input : [];
      elapsed = +d.elapsed || 0;
      elInc3.checked = includeLeading3;
      updateTargetCount();
      elStartAt.value = String(indexToPos(startAt));
      elEntry.value = "";
      startTime = null;
      render();
      flash(elLoad, "Loaded!");
    } catch (e) {
      alert("Failed to load save.");
    }
  }

  // Leaderboard
  function loadLB() {
    const raw = localStorage.getItem(STORAGE_KEYS.LB);
    return raw ? JSON.parse(raw) : [];
  }
  function saveLB(list) { localStorage.setItem(STORAGE_KEYS.LB, JSON.stringify(list)); }
  function updateLBUI() {
    const list = loadLB();
    elLBList.innerHTML = "";
    if (!list.length) {
      const li = document.createElement('li'); li.textContent = "No scores yet."; elLBList.appendChild(li); return;
    }
    list.forEach((e, i) => {
      const li = document.createElement('li');
      li.textContent = `${i+1}. ${e.name}: ${e.score} digits in ${e.time.toFixed(1)}s on ${e.date}`;
      elLBList.appendChild(li);
    });
  }
  function submitScore() {
    const score = computeScore();
    const name = prompt("Name for the leaderboard:");
    if (!name) return;
    const entry = { name, score, time: elapsed, date: new Date().toISOString().replace('T',' ').slice(0,19) };
    const list = loadLB();
    list.push(entry);
    list.sort((a,b) => (b.score - a.score) || (a.time - b.time));
    saveLB(list.slice(0, MAX_LEAD));
    updateLBUI();
    alert("Score submitted!");
  }

  // Rendering
  function render() {
    elScore.textContent = computeScore();
    elDigits.innerHTML = "";
    if (!showDigits) return;

    const seq = ACTIVE_SEQ();
    const tgtSlice = seq.slice(startAt);

    let colCount = 0;
    input.forEach((ch, i) => {
      const sp = document.createElement('span');
      sp.className = "d " + (ch === tgtSlice[i] ? "ok" : "bad");
      sp.textContent = ch;
      sp.dataset.i = i.toString();
      // FIX: show true 1-based position
      sp.title = `Position #${indexToPos(startAt + i)}`;
      elDigits.appendChild(sp);

      colCount++;
      if (colCount % SPACE_EVERY === 0) {
        const s = document.createElement('span'); s.className = "sp"; s.textContent = " "; elDigits.appendChild(s);
      }
      if (colCount % MAX_PER_LINE === 0) {
        const nl = document.createElement('span'); nl.className = "nl"; elDigits.appendChild(nl);
      }

      // visually show '.' after the global first digit when includeLeading3 is ON
      const globalIndex = startAt + i;
      if (includeLeading3 && globalIndex === 0) {
        const dot = document.createElement('span'); dot.className = "d muted"; dot.textContent = '.'; elDigits.appendChild(dot);
      }
    });
  }

  // Click to jump back
  elDigits.addEventListener('click', (e) => {
    const tgt = e.target;
    if (tgt.classList.contains('d') && tgt.dataset.i) {
      const idx = parseInt(tgt.dataset.i, 10);
      input = input.slice(0, idx);
      render();
      elEntry.focus();
    }
  });

  // Entry handling
  elEntry.addEventListener('keydown', (e) => {
    if (e.key === "Backspace") {
      if (input.length > 0) { input.pop(); render(); }
      e.preventDefault(); return;
    }
    if (/^\d$/.test(e.key)) {
      startTimerIfNeeded();
      const tgt = ACTIVE_SEQ().slice(startAt);
      if (input.length < tgt.length) { input.push(e.key); render(); }
      e.preventDefault(); return;
    }
  });

  // Controls
  elToggle.addEventListener('click', () => {
    showDigits = !showDigits;
    elToggle.textContent = showDigits ? "Hide Digits" : "Show Digits";
    render();
  });
  elSave.addEventListener('click', saveProgress);
  elLoad.addEventListener('click', loadProgress);
  elReset.addEventListener('click', () => { resetGame(true); });
  elSubmit.addEventListener('click', submitScore);

  elStartAt.addEventListener('change', () => {
    startAt = posToIndex(elStartAt.value);
    input = [];
    render();
    elEntry.value = "";
    elEntry.focus();
  });

  elInc3.addEventListener('change', () => {
    const currentPos = indexToPos(startAt); // remember visible position (1-based)
    includeLeading3 = elInc3.checked;
    updateTargetCount();
    startAt = posToIndex(currentPos);
    input = [];
    elStartAt.value = String(indexToPos(startAt));
    render();
    elEntry.focus();
  });

  // Load from local file
  elFile.addEventListener('change', async (e) => {
    const file = e.target.files?.[0]; if (!file) return;
    try {
      const txt = await file.text();
      piFull = parsePiText(txt);
      localStorage.setItem(STORAGE_KEYS.PI, piFull);
      updateTargetCount();
      input = [];
      startAt = 0;
      elStartAt.value = "1";
      render();
      elEntry.focus();
    } catch (err) {
      alert("Could not parse the file: " + err.message);
    }
  });

  // Demo (~1000 digits, compact one-liner)
  elUseDemo.addEventListener('click', () => {
    const demo = "3.14159265358979323846264338327950288419716939937510582097494459230781640628620899862803482534211706798214808651328230664709384460955058223172535940812848111745028410270193852110555964462294895493038196442881097566593344612847564823378678316527120190914564856692346034861045432664821339360726024914127372458700660631558817488152092096282925409171536436789259036001133053054882046652138414695194151160943305727036575959195309218611738193261179310511854807446237996274956735188575272489122793818301194912";
    piFull = parsePiText(demo);
    localStorage.setItem(STORAGE_KEYS.PI, piFull);
    updateTargetCount();
    input = [];
    startAt = 0;
    elStartAt.value = "1";
    render();
    elEntry.focus();
  });

  // Load pi_15000.txt from same folder (cache-busted)
  async function loadPiFromUrl(url) {
    try {
      const bust = url + (url.includes("?") ? "&" : "?") + "_cb=" + Date.now();
      const res = await fetch(bust, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const txt = await res.text();
      piFull = parsePiText(txt);
      localStorage.setItem(STORAGE_KEYS.PI, piFull);
      updateTargetCount();
      input = [];
      startAt = 0;
      elStartAt.value = "1";
      render();
      elEntry.focus();
      flash(elLoadRepo, "Loaded!");
    } catch (err) {
      alert("Failed to fetch pi_15000.txt: " + err.message);
    }
  }
  elLoadRepo.addEventListener('click', () => loadPiFromUrl("pi_15000.txt"));
  elGhUrl.addEventListener('keydown', (e) => {
    if (e.key === "Enter") {
      const u = elGhUrl.value.trim(); if (!u) return;
      loadPiFromUrl(u);
    }
  });

  // Init
  const stored = localStorage.getItem(STORAGE_KEYS.PI);
  if (stored && /^3\./.test(stored)) piFull = stored;
  updateTargetCount();
  updateLBUI();
  elInc3.checked = includeLeading3;
  elStartAt.value = "1";
  render();
  elEntry.focus();
})();
</script>


<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js").catch(console.error);
  });
}
</script>
</body>
</html>
